#                                                                    -*-perl-*-

$description = "The following test creates a makefile to test wildcard
expansions and the ability to put a command on the same
line as the target name separated by a semi-colon.";

$details = "\
This test creates 4 files by the names of 1.example,
two.example and 3.example.  We execute three tests.  The first
executes the print1 target which tests the '*' wildcard by
echoing all filenames by the name of '*.example'.  The second
test echo's all files which match '?.example' and
[a-z0-9].example.  Lastly we clean up all of the files using
the '*' wildcard as in the first test";

open(MAKEFILE,"> $makefile");

# The Contents of the MAKEFILE ...

print MAKEFILE <<EOM;
.PHONY: print1 print2 print3 clean
print1: ;\@echo \$(sort \$(wildcard example.*))
print2:
\t\@echo \$(sort \$(wildcard example.?))
\t\@echo \$(sort \$(wildcard example.[a-z0-9]))
\t\@echo \$(sort \$(wildcard example.[!A-Za-z_\\!]))
print3:
\t\@echo \$(sort \$(wildcard hello*))
\t\@echo \$(sort \$(wildcard hello*/))
\t\@echo \$(sort \$(wildcard hellod/world*))
\t\@echo \$(sort \$(wildcard hellod/world*/))
\t\@echo \$(sort \$(wildcard hello* hellod/world*))
\t\@echo \$(sort \$(wildcard hello*/ hellod/world*/))
\t\@echo \$(sort \$(wildcard /))
\t\@echo \$(sort \$(wildcard hellod/*))
\t\@echo \$(sort \$(wildcard hellod/*/))
\t\@echo \$(sort \$(wildcard */world*))
\t\@echo \$(sort \$(wildcard */worldd/))
\t\@echo \$(sort \$(wildcard hellod/*/ken*/))
\t\@echo \$(sort \$(wildcard hellod/*/ken?[12]))
\t\@echo \$(sort \$(wildcard hellod/*/ken?[12]/))

clean:
\t$CMD_rmfile \$(sort \$(wildcard example.* hellof hellod))
EOM

# END of Contents of MAKEFILE

close(MAKEFILE);

&touch("example.1");
&touch("example.two");
&touch("example.3");
&touch("example.for");
&touch("example._");
&touch("hellof");
mkdir("hellod", 0770);
mkdir("hellod/worldd", 0770);
&touch("hellod/worldf");
mkdir("hellod/worldd/kend1", 0770);
mkdir("hellod/worldd/kend2", 0770);
&touch("hellod/worldd/kenf1");
&touch("hellod/worldd/kenf2");

# TEST #1
# -------

$answer = "example.1 example.3 example._ example.for example.two\n";

&run_make_with_options($makefile,"print1",&get_logfile);

&compare_output($answer,&get_logfile(1));


# TEST #2
# -------

$answer = "example.1 example.3 example._\n"
         ."example.1 example.3\n"
         ."example.1 example.3\n";

&run_make_with_options($makefile,"print2",&get_logfile);

&compare_output($answer,&get_logfile(1));

# TEST #3: verify that when the input pattern has a trailing slash wildcard
# returns only directories.
# -------

$answer = "hellod hellof\n"
         ."hellod/\n"
         ."hellod/worldd hellod/worldf\n"
         ."hellod/worldd/\n"
         ."hellod hellod/worldd hellod/worldf hellof\n"
         ."hellod/ hellod/worldd/\n"
         ."/\n"
         ."hellod/worldd hellod/worldf\n"
         ."hellod/worldd/\n"
         ."hellod/worldd hellod/worldf\n"
         ."hellod/worldd/\n"
         ."hellod/worldd/kend1/ hellod/worldd/kend2/\n"
         ."hellod/worldd/kend1 hellod/worldd/kend2 "
         ."hellod/worldd/kenf1 hellod/worldd/kenf2\n"
         ."hellod/worldd/kend1/ hellod/worldd/kend2/\n";

&run_make_with_options($makefile,"print3",&get_logfile);
&compare_output($answer,&get_logfile(1));

# TEST #4
# -------

$answer = "$CMD_rmfile example.1 example.3 example._ example.for example.two"
         ." hellod hellof";
if ($vos)
{
   $answer .= " \n";
}
else
{
   $answer .= "\n";
}

&run_make_with_options($makefile,"clean",&get_logfile);

if ((-f "example.1")||(-f "example.two")||(-f "example.3")||(-f "example.for")) {
   $test_passed = 0;
}

&compare_output($answer,&get_logfile(1));

# TEST #5: Verify that failed wildcards don't return the pattern

run_make_test(q!
all: ; @echo $(wildcard xz--y*.7)
!,
              '', "\n");

# TEST #6: wildcard used to verify file existence

touch('xxx.yyy');

run_make_test(q!exists: ; @echo file=$(wildcard xxx.yyy)!,
              '', "file=xxx.yyy\n");

unlink('xxx.yyy');

run_make_test(q!exists: ; @echo file=$(wildcard xxx.yyy)!,
              '', "file=\n");

1;
